<?php

// MODULARIZE (say whaat?)
// ------------------------------------
// $module = new Object();
// $module->exports = new Object();

   $exports = new Object();
// ------------------------------------


   $exports->config = JSAM::parse('src/cfg/cfg.css.jsam');

   $exports->render = function($slf, $dfn)
   {
      if (!function_exists('buildCSS'))
      {
         function buildCSS($dfn, $lvl, $cfg)
         {
         // locals
         // ----------------------------------------------------------------------
            $rsl = '';
            $ind = '';
         // ----------------------------------------------------------------------

         // indentation
         // ----------------------------------------------------------------------
            for ($l=0; $l<$lvl; $l++)
            { $ind .= '   '; }
         // ----------------------------------------------------------------------

         // build node list
         // ----------------------------------------------------------------------
            foreach($dfn as $key => $val)
            {
            // attributes
            // -------------------------------------------------------------------
               if (is_int($key))
               {
                  $sel = array_keys($val)[0];
                  $atr = $val[$sel];
               }
               else
               {
                  $sel = $key;
                  $atr = $val;
               }

               $mlt = false;
            // -------------------------------------------------------------------

            // single or multi-line
            // -------------------------------------------------------------------
               if (isset($atr[0]) || (count($atr) > 1))
               { $mlt = true; }
            // -------------------------------------------------------------------

            // node start
            // -------------------------------------------------------------------
               $rsl .= $ind.$sel."\n";
               $rsl .= $ind.'{';
            // -------------------------------------------------------------------

            // node contents
            // -------------------------------------------------------------------
               if ($mlt === true)
               { $rsl .= "\n"; }
               else
               { $rsl .= ' '; }

               if (isset($atr[0]))
               {
                  $lvl++;
                  $rsl .= buildCSS($atr, $lvl, $cfg);
                  $lvl--;
               }
               else
               {
                  foreach($atr as $nme => $pty)
                  {
                     $tmp = $ind.$nme.': '.$pty.';';

                     if ($mlt === true)
                     { $rsl .= '   '.$tmp; }
                     else
                     { $rsl .= $tmp; }

                     if ($mlt === true)
                     { $rsl .= "\n"; }
                     else
                     { $rsl .= ' '; }
                  }
               }
            // -------------------------------------------------------------------

            // node end
            // -------------------------------------------------------------------
               $rsl .= $ind.'}'."\n\n";
            // -------------------------------------------------------------------
            }
         // ----------------------------------------------------------------------

         // return result
         // ----------------------------------------------------------------------
            return rtrim($rsl)."\n";
         // ----------------------------------------------------------------------
         }
      }

      $dfn = $dfn['text/css'];
      $css = "\n";

      $css .= rtrim(buildCSS($dfn, 0, $slf->config));

      $rsl = new Object();
      $rsl->headers = array();
      $rsl->content = $css;

      return $rsl;
   };

?>
